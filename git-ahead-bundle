#!/bin/sh

if [ $# -ne 0 ]
then
	echo "Usage: $0" >&2
	exit 1
fi

tlog=/tmp/bundle.$$
echo > $tlog

cleanup(){
	ec=$?
	cat $tlog
	rm -f $tlog
	if [ $ec -ne 0 ]
	then echo >&2 "bundle error"
	fi
	exit $ec
}

trap cleanup EXIT

git-ahead | while read n b r
do
	f="$(basename "$(pwd)").$(echo "$b" | tr / _)".bundle

	git bundle create "$f" origin/"$b".."$b" || exit $?
	echo "wrote $f" >> $tlog
done
