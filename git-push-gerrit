#!/bin/sh

dry=
flags=
if [ "$1" = -n ]
then
	dry=echo
	shift
fi
if [ "$1" = -n ]
then
	dry=
	flags=-n
	shift
fi

if [ $# -ne 3 ]
then
	echo >&2 "Usage: $0 [-n] [-n] remote refspec target-branch"
	echo >&2 "-n specified twice will pass the dry run through to git-push"
	exit 1
fi

remote="$1"
refsp="$2"
target="$3"

set -e

$dry git push $flags "$remote" "$refsp":refs/for/"$target"
if [ -z "$flags" ]
then $dry git tag -f gerrit/last-pushed/"$target" "$refsp"
fi
